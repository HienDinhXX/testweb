<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quáº£n lÃ½ tÃ i sáº£n</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
body{
  font-family:-apple-system,sans-serif;
  background:#f2f2f7;
  padding:15px;
  font-size:14px;
}
.card{
  background:white;
  padding:12px;
  border-radius:12px;
  box-shadow:0 3px 8px rgba(0,0,0,0.05);
  margin-bottom:15px;
}
h2{font-size:16px;margin-bottom:8px;}
input,select{
  width:100%;
  padding:6px;
  margin:5px 0;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  padding:6px 8px;
  margin-top:5px;
  border-radius:6px;
  border:none;
  font-size:12px;
}
.addBtn{background:#007AFF;color:white;width:100%;}
.editBtn{background:#ff9500;color:white;}
.deleteBtn{background:#ff3b30;color:white;}
.item{padding:6px 0;border-bottom:1px solid #eee;font-size:13px;}
.total{font-size:16px;font-weight:bold;}
#lockScreen{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:#f2f2f7;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}
</style>
</head>
<body>

<div id="lockScreen">
  <h2>ğŸ” Nháº­p máº­t kháº©u</h2>
  <input type="password" id="pinInput">
  <button class="addBtn" onclick="checkPIN()">Má»Ÿ</button>
  <p id="pinError" style="color:red;"></p>
</div>

<div id="app" style="display:none;">

<div class="card">
<h2>ğŸ¥‡ VÃ ng</h2>
<label>GiÃ¡ vÃ ng (VND / chá»‰)</label>
<input type="text" id="goldPrice">
<input type="text" id="goldName" placeholder="TÃªn cá»­a hÃ ng">
<input type="number" step="0.01" id="goldQty" placeholder="Sá»‘ lÆ°á»£ng (chá»‰)">
<input type="text" id="goldNote" placeholder="Ghi chÃº (khÃ´ng báº¯t buá»™c)">
<button class="addBtn" onclick="addGold()">ThÃªm vÃ ng</button>
<div id="goldList"></div>
</div>

<div class="card">
<h2>ğŸ¦ Sá»• tiáº¿t kiá»‡m cá»©ng</h2>
<input type="text" id="bankName" placeholder="TÃªn ngÃ¢n hÃ ng">
<input type="text" id="bankAmount" placeholder="Sá»‘ tiá»n">
<input type="date" id="bankDate">
<button class="addBtn" onclick="addBank()">ThÃªm</button>
<div id="bankList"></div>
</div>

<div class="card">
<h2>ğŸ’³ Sá»• tiáº¿t kiá»‡m online</h2>
<input type="text" id="onlineAmount" placeholder="Sá»‘ tiá»n">
<input type="date" id="onlineDate">
<button class="addBtn" onclick="addOnline()">ThÃªm</button>
<div id="onlineList"></div>
</div>

<div class="card">
<h2>ğŸ’± Ngoáº¡i tá»‡</h2>
<select id="foreignCurrency">
<option value="USD">USD</option>
<option value="EUR">EUR</option>
<option value="JPY">JPY</option>
<option value="KRW">KRW</option>
<option value="CNY">CNY</option>
</select>
<input type="text" id="foreignAmount" placeholder="Sá»‘ tiá»n">
<input type="text" id="foreignNote" placeholder="Ghi chÃº (khÃ´ng báº¯t buá»™c)">
<button class="addBtn" onclick="addForeign()">ThÃªm</button>
<div id="foreignList"></div>
</div>

<div class="card">
<h2>ğŸ“Š Tá»· lá»‡ tÃ i sáº£n</h2>
<canvas id="assetChart"></canvas>
</div>

<div class="card total" id="grandTotal">
Tá»•ng tÃ i sáº£n: 0 VND
</div>

</div>

<script>
let golds=[],banks=[],onlines=[],foreigns=[];
let assetChart;
let lockTimer;
const FIXED_PIN="981202";

/* ===== LOCK ===== */
function resetTimer(){
  clearTimeout(lockTimer);
  lockTimer=setTimeout(lockApp,180000);
}
function lockApp(){
  app.style.display="none";
  lockScreen.style.display="flex";
  pinInput.value="";
}
document.addEventListener("visibilitychange",()=>{
  if(document.hidden) lockApp();
});

/* ===== PIN ===== */
function checkPIN(){
  if(pinInput.value===FIXED_PIN){
    lockScreen.style.display="none";
    app.style.display="block";
    loadData();
    resetTimer();
  }else{
    pinError.innerText="Sai máº­t kháº©u!";
  }
}

/* ===== FORMAT ===== */
function formatNumber(num){
  return Number(num).toLocaleString("vi-VN");
}
function parseNumber(str){
  if(!str) return 0;
  str=str.replace(/\./g,"");
  let n=Number(str)||0;
  return Math.round(n/1000)*1000;
}
function formatInput(input){
  input.addEventListener("input",()=>{
    let v=input.value.replace(/\D/g,"");
    if(!v){input.value="";return;}
    input.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  });
}

/* ===== SAVE ===== */
function saveData(){
  localStorage.setItem("golds",JSON.stringify(golds));
  localStorage.setItem("banks",JSON.stringify(banks));
  localStorage.setItem("onlines",JSON.stringify(onlines));
  localStorage.setItem("foreigns",JSON.stringify(foreigns));
  localStorage.setItem("goldPrice",goldPrice.value);
}
function loadData(){
  golds=JSON.parse(localStorage.getItem("golds"))||[];
  banks=JSON.parse(localStorage.getItem("banks"))||[];
  onlines=JSON.parse(localStorage.getItem("onlines"))||[];
  foreigns=JSON.parse(localStorage.getItem("foreigns"))||[];
  goldPrice.value=localStorage.getItem("goldPrice")||"";
  render();
}

/* ===== ADD ===== */
function addGold(){
  if(!goldName.value||!goldQty.value)return;
  golds.push({
    name:goldName.value,
    qty:Number(goldQty.value),
    note:goldNote.value||""
  });
  goldName.value="";goldQty.value="";goldNote.value="";
  saveData();render();
}
function addBank(){
  if(!bankName.value||!bankAmount.value)return;
  banks.push({
    name:bankName.value,
    amount:parseNumber(bankAmount.value),
    date:bankDate.value
  });
  bankName.value="";bankAmount.value="";bankDate.value="";
  saveData();render();
}
function addOnline(){
  if(!onlineAmount.value)return;
  onlines.push({
    amount:parseNumber(onlineAmount.value),
    date:onlineDate.value
  });
  onlineAmount.value="";onlineDate.value="";
  saveData();render();
}
async function addForeign(){
  if(!foreignAmount.value)return;
  let cur=foreignCurrency.value;
  let res=await fetch(`https://api.exchangerate.host/latest?base=${cur}&symbols=VND`);
  let data=await res.json();
  let rate=data.rates.VND||0;
  let amount=Number(foreignAmount.value.replace(/\./g,""));
  let vnd=Math.round((amount*rate)/1000)*1000;
  foreigns.push({
    currency:cur,
    amount:amount,
    value:vnd,
    note:foreignNote.value||""
  });
  foreignAmount.value="";foreignNote.value="";
  saveData();render();
}

/* ===== DELETE ===== */
function deleteItem(arr,i){
  if(confirm("XoÃ¡ má»¥c nÃ y?")){
    arr.splice(i,1);
    saveData();render();
  }
}

/* ===== RENDER ===== */
function render(){
  let price=parseNumber(goldPrice.value);
  goldPrice.value=price?formatNumber(price):"";

  let goldTotal=0;
  goldList.innerHTML=golds.map((g,i)=>{
    let total=Math.round((g.qty*price)/1000)*1000;
    goldTotal+=total;
    return `<div class="item">
      ${g.name} - ${g.qty} chá»‰ = ${formatNumber(total)} VND
      ${g.note?`<br>ğŸ“ ${g.note}`:""}
      <br><button class="deleteBtn" onclick="deleteItem(golds,${i})">XoÃ¡</button>
    </div>`;
  }).join("");

  let bankTotal=0;
  bankList.innerHTML=banks.map((b,i)=>{
    bankTotal+=b.amount;
    return `<div class="item">
      ${b.name} - ${formatNumber(b.amount)} VND
      <br><button class="deleteBtn" onclick="deleteItem(banks,${i})">XoÃ¡</button>
    </div>`;
  }).join("");

  let onlineTotal=0;
  onlineList.innerHTML=onlines.map((o,i)=>{
    onlineTotal+=o.amount;
    return `<div class="item">
      ${formatNumber(o.amount)} VND
      <br><button class="deleteBtn" onclick="deleteItem(onlines,${i})">XoÃ¡</button>
    </div>`;
  }).join("");

  let foreignTotal=0;
  foreignList.innerHTML=foreigns.map((f,i)=>{
    foreignTotal+=f.value;
    return `<div class="item">
      ${formatNumber(f.amount)} ${f.currency}
      â‰ˆ ${formatNumber(f.value)} VND
      ${f.note?`<br>ğŸ“ ${f.note}`:""}
      <br><button class="deleteBtn" onclick="deleteItem(foreigns,${i})">XoÃ¡</button>
    </div>`;
  }).join("");

  grandTotal.innerText="Tá»•ng tÃ i sáº£n: "+
    formatNumber(goldTotal+bankTotal+onlineTotal+foreignTotal)+" VND";

  drawChart(goldTotal,bankTotal,onlineTotal,foreignTotal);
}

/* ===== CHART ===== */
function drawChart(a,b,c,d){
  if(assetChart) assetChart.destroy();
  assetChart=new Chart(assetChart=document.getElementById("assetChart"),{
    type:"pie",
    data:{
      labels:["VÃ ng","Sá»• cá»©ng","Online","Ngoáº¡i tá»‡"],
      datasets:[{
        data:[a,b,c,d],
        backgroundColor:["#FFD700","#007AFF","#34C759","#AF52DE"]
      }]
    }
  });
}

/* ===== INIT ===== */
formatInput(bankAmount);
formatInput(onlineAmount);
formatInput(foreignAmount);
formatInput(goldPrice);

goldPrice.addEventListener("input",()=>{saveData();render();});

window.onload=()=>lockScreen.style.display="flex";
</script>
</body>
</html>